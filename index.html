<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>OpenAI GPT-Turbo 3.5 Example</title>
  <style>
    .example-prompt {
      margin-right: 10px;
    }

    .example-response {
      margin-right: 10px;
    }

    .remove-example {
      background-color: red;
      color: white;
      border: none;
      border-radius: 5px;
      margin-left: 10px;
      cursor: pointer;
    }

    #error-message {
      color: red;
    }
  </style>
</head>

<body>
  <h1>OpenAI GPT-Turbo 3.5 Example</h1>
  <p>Enter some example prompts and responses, and a target prompt, and click the "Generate Response" button to see a response generated by the GPT-Turbo 3.5 model:</p>

  <label for="apiKey">OpenAI API Key:</label>
  <input type="text" id="apiKey" name="apiKey"><br><br>

  <form id="form">
    <div id="examples">
      <div class="example">
        <label class="example-prompt" for="prompt1">Prompt 1:</label>
        <input class="prompt" type="text" name="prompt1" required>
        <label class="example-response" for="response1">Response 1:</label>
        <input class="response" type="text" name="response1" required>
      </div>
    </div>
    <button id="add-example" type="button">Add Example</button>

    <label for="targetPrompt">Target Prompt:</label>
    <input type="text" name="targetPrompt" required><br>

    <div id="error-message"></div>
    <button type="submit">Generate Response</button>
  </form>
  <div id="response"></div>

  <script>
    // Add event listener to the "Add Example" button
    const addExampleBtn = document.querySelector("#add-example");
    addExampleBtn.addEventListener("click", addExample);

    // Add event listener to the form submit button
    const form = document.querySelector("#form");
    form.addEventListener("submit", generateResponse);

    /**
     * Add a new example prompt and response field to the form.
     */
    function addExample() {
      const examples = document.querySelector("#examples");
      const exampleCount = examples.children.length;
      const newExample = document.createElement("div");
      newExample.className = "example";
      newExample.innerHTML = `
				<label class="example-prompt" for="prompt${exampleCount + 1}">Prompt ${exampleCount + 1}:</label>
				<input class="prompt" type="text" name="prompt${exampleCount + 1}" required>
				<label class="example-response" for="response${exampleCount + 1}">Response ${exampleCount + 1}:</label>
				<input class="response" type="text" name="response${exampleCount + 1}" required>
				<button class="remove-example" type="button">Remove</button>
			`;
      const removeExampleBtn = newExample.querySelector(".remove-example");
      removeExampleBtn.addEventListener("click", removeExample);
      examples.appendChild(newExample);
    }

    /**
     * Remove the parent example element of the clicked "Remove" button.
     * @param {Event} event - The click event.
     */
    function removeExample(event) {
      const example = event.target.closest(".example");
      example.remove();
    }

    /**
     * Generate a response using the GPT-Turbo 3.5 model.
     * **/

    async function generateResponse(event) {
      event.preventDefault();

      try {
        // Gather the inputs
        const apiKey = validateApiKey(document.getElementById("apiKey").value);
        const prompts = [];
        const responses = [];
        const promptInputs = document.querySelectorAll(".prompt");
        const responseInputs = document.querySelectorAll(".response");
        let messages = [];
        for (let i = 0; i < promptInputs.length; i++) {
          prompts.push(promptInputs[i].value);
          responses.push(responseInputs[i].value);
          messages.push({"role": "user", "content": prompts[i]});
          messages.push({"role": "assistant", "content": responses[i]});
        }
        const targetPrompt = document.querySelector("input[name=targetPrompt]").value;

        const systemMessage = `You are able to perfectly impersonate the writing style of anyone you've ever read, and you are able to write articles that are indistinguishable from those written by the original author. Write articles based on user input, and make sure to respond with the same style, tone, voice, vocabulary, attitude, and personality represented in your first responses. Make sure the articles you write are no longer than 1250 words each.`;

        const userMessage = targetPrompt;

        const requestData = {
          model: "gpt-3.5-turbo",
          messages: [
            {"role": "system", "content": systemMessage},
            ...messages,
            {"role": "user", "content": userMessage},
          ],
          temperature: 1.0,
          top_p: 1.0,
          n: 1,
          max_tokens: 512,
        };

        // Send the API request
        const response = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + apiKey,
          },
          body: JSON.stringify(requestData),
        });
        const responseData = await response.json();

        // Display the response
        const responseDiv = document.querySelector("#response");
        responseDiv.innerHTML = `<p>${responseData.choices[0].text}</p>`;
      } catch (error) {
        const errorMessageElement = document.getElementById('error-message');
        errorMessageElement.innerText = error.message;
      }
    }

    function validateApiKey(apiKey) {
      try {
        // Check if API key is present
        if (!apiKey) {
          throw new Error('API key is required.');
        }

        // Check if API key matches expected pattern (starts with "sk_")
        const regex = /^sk-/;
        if (!regex.test(apiKey)) {
          throw new Error('Invalid API key format.');
        }

        // Sanitize API key to remove any potentially malicious characters
        const sanitizedApiKey = apiKey.replace(/[^a-zA-Z0-9_\-]/g, '');

        return sanitizedApiKey;
      } catch (error) {
        // Display error message in HTML element
        const errorMessageElement = document.getElementById('error-message');
        errorMessageElement.innerText = error.message;
        throw error;
      }
    }
  </script>
</body>

</html>