<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>OpenAI GPT-Turbo 3.5 Example</title>
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }
    p {
      margin: 5px;
    }
    div {
      display: flex;
      flex-direction: column;
    }
    .api-input {
      width: 100%;
      flex: 1;
      margin-bottom: 5px;
    }
    .example {
      display: flex;
      flex: 1;
      width: '100%';
    }
    .example-row {
      display: flex;
      flex-direction: row;
      align-items: center;
      margin-top: 10px;
      width: '100%';
    }
    .example-item {
      display: flex;
      flex: 1;
      width: '100%';
      margin: 5px;
    }
    .example-label {
      display: flex;
      margin-right: 10px;
    }
    .example-input {
      width: 100%;
      flex: 1;
    }
    .target-label {
      display: flex;
      margin-right: 10px;
      margin-top: 10px;
    }
    .target-input {
      width: 100%;
      flex: 1;
    }
    .add-button {
      background-color: #0066fa;
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      margin-left: 5px;
      margin-bottom: 10px;
      padding: 8px 16px;
    }
    .submit-button {
      background-color: #0066fa;
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      margin-left: 5px;
      padding: 8px 16px;
    }
    .remove-button {
      background-color: #f44336;
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      margin-left: 5px;
      padding: 8px 16px;
    }
    .message {
      margin: 5px;
      margin-bottom: 10px;
    }
    .header {
      font-size: 36px;
      font-weight: bold;
      margin: 5px;
      margin-bottom: 10px;
    }
    .spinner {
      border: 0.2em solid rgba(0, 0, 0, 0.1);
      border-top: 0.2em solid #0066fa;
      border-radius: 50%;
      width: 1.5em;
      height: 1.5em;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>
  <div class="header">OpenAI GPT-Turbo 3.5 Example</div>
  <div class="message">Enter some example prompts and responses, and a target prompt, and click the "Generate Response" button to see a response generated by the GPT-Turbo 3.5 model:</div>

  <div class="example-item">
    <label for="apiKey">OpenAI API Key:</label>
    <input class="api-input" type="text" id="apiKey" name="apiKey">
  </div>

  <form id="form">
    <div id="examples">
      <div class="example">
        <div class="example-row">
          <div class="example-item">
            <label class="example-label" for="prompt1">Prompt 1:</label>
            <textarea rows="4" class="example-input prompt" type="text" name="prompt1" required></textarea>
          </div>
          <div class="example-item">
            <label class="example-label" for="response1">Response 1:</label>
            <textarea rows="4" class="example-input response" type="text" name="response1" required></textarea>
          </div>
        </div>
      </div>
    </div>
    </div>
    <button class="add-button" id="add-example" type="button">Add Example</button>


    <div class="example-item">
      <label class="target-label" for="temp-slider">Randomness (creativity?):</label>
      <input type="range" id="tempSlider" name="tempSlider" min="0" max="1" step="0.1" >
    </div>

    <div class="example-item">
      <label class="target-label" for="targetPrompt">Target Prompt:</label>
      <textarea rows="4" class="target-input" type="text" name="targetPrompt" required></textarea>
    </div>

    <div id="error-message"></div>
    <button id="submit-button" class="submit-button" type="submit">Generate Response</button>
    <span id="spinner" class="spinner" style="display: none;"></span>
  </form>
  <div class="example-item">
    <div id="response"></div>
  </div>

  <script>
    // Add event listener to the "Add Example" button
    const addExampleBtn = document.querySelector("#add-example");
    addExampleBtn.addEventListener("click", addExample);

    // Add event listener to the form submit button
    const form = document.querySelector("#form");
    form.addEventListener("submit", generateResponse);

    /**
     * Add a new example prompt and response field to the form.
     */
    function addExample() {
      const examples = document.querySelector("#examples");
      const exampleCount = examples.children.length;
      const newExample = document.createElement("div");
      newExample.className = "example";
      newExample.innerHTML = `
        <div class="example-row">
          <div class="example-item">
            <label class="example-label" for="prompt${exampleCount + 1}">Prompt ${exampleCount + 1}:</label>
            <textarea rows="4" class="example-input prompt" type="text" name="prompt${exampleCount + 1}" required></textarea>
          </div>
          <div class="example-item">
            <label class="example-label" for="response${exampleCount + 1}">Response ${exampleCount + 1}:</label>
            <textarea rows="4" class="example-input response" type="text" name="response${exampleCount + 1}" required></textarea>
          </div>
          <button class="remove-button" type="button">Remove</button>
        </div>

			`;
      const removeExampleBtn = newExample.querySelector(".remove-button");
      removeExampleBtn.addEventListener("click", removeExample);
      examples.appendChild(newExample);
    }

    /**
     * Remove the parent example element of the clicked "Remove" button.
     * @param {Event} event - The click event.
     */
    function removeExample(event) {
      const example = event.target.closest(".example");
      example.remove();
    }

    /**
     * Generate a response using the GPT-Turbo 3.5 model.
     * **/

    async function generateResponse(event) {
      event.preventDefault();

      try {

        const errorMessageElement = document.getElementById('error-message');
        errorMessageElement.innerText = '';

        // Show the activity indicator.
        document.getElementById("spinner").style.display = "inline-block";

        // Disable the submit button to prevent multiple submissions.
        document.getElementById("submit-button").style.display = 'none';

        // Gather the inputs
        const apiKey = validateApiKey(document.getElementById("apiKey").value);
        const prompts = [];
        const responses = [];
        const promptInputs = document.querySelectorAll(".prompt");
        const responseInputs = document.querySelectorAll(".response");
        let messages = [];
        for (let i = 0; i < promptInputs.length; i++) {
          prompts.push(promptInputs[i].value);
          responses.push(responseInputs[i].value);
          messages.push({ "role": "user", "content": prompts[i] });
          messages.push({ "role": "assistant", "content": responses[i] });
        }
        
        const temperature = Number(document.querySelector("input[name=tempSlider]").value);
        
        // console.log(`temperature: ${temperature}`);

        const targetPrompt = document.querySelector("textarea[name=targetPrompt]").value;

        // console.log(`targetPrompt: ${targetPrompt}`);

        const systemMessage = `You are able to perfectly impersonate the writing style of anyone you've ever read, and you are able to write articles that are indistinguishable from those written by the original author. Write articles based on user input, and make sure to respond with the same style, tone, voice, vocabulary, attitude, and personality represented in your first responses. Make sure the articles you write are no longer than 1250 words each.`;

        // console.log(`systemMessage: ${systemMessage}`);

        const userMessage = targetPrompt;

        // console.log(`userMessage: ${userMessage}`);

        const requestData = {
          model: "gpt-3.5-turbo",
          messages: [
            { "role": "system", "content": systemMessage },
            ...messages,
            { "role": "user", "content": userMessage },
          ],
          temperature: temperature,
          //top_p: 1.0,
          n: 1,
          max_tokens: 512,
        };

        // console.log(`requestData: ${JSON.stringify(requestData, null, 2)}`);

        // Send the API request
        const response = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + apiKey,
          },
          body: JSON.stringify(requestData),
        });
        const responseData = await response.json();

        // Display the response
        const responseDiv = document.querySelector("#response");
        responseDiv.innerHTML = `<p>${responseData.choices[0].message.content}</p>`;

        // Hide the activity indicator.
        document.getElementById("spinner").style.display = "none";

        // Re-enable the submit button.
        document.getElementById("submit-button").style.display = "inline-block";

      } catch (error) {
        const errorMessageElement = document.getElementById('error-message');
        errorMessageElement.innerText = error;
      }
    }

    function validateApiKey(apiKey) {
      try {
        // Check if API key is present
        if (!apiKey) {
          throw new Error('API key is required.');
        }

        // Check if API key matches expected pattern (starts with "sk_")
        const regex = /^sk-/;
        if (!regex.test(apiKey)) {
          throw new Error('Invalid API key format.');
        }

        // Sanitize API key to remove any potentially malicious characters
        const sanitizedApiKey = apiKey.replace(/[^a-zA-Z0-9_\-]/g, '');

        return sanitizedApiKey;
      } catch (error) {
        // Display error message in HTML element
        const errorMessageElement = document.getElementById('error-message');
        errorMessageElement.innerText = error.message;
        throw error;
      }
    }
  </script>
</body>

</html>